<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diagn√≥stico Funcional - Ciente IE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f8fafc; }
    .aba { cursor: pointer; padding: .75rem 1.5rem; border-radius: 9999px; transition: .2s; }
    .aba.active { background-color: #2563eb; color: white; }
    .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem; margin-bottom: 1rem; }
    .btn { background-color: #2563eb; color: white; padding: .5rem 1rem; border-radius: 8px; cursor: pointer; transition: .2s; }
    .btn:hover { background-color: #1d4ed8; }
    .modal { display: none; }
    .modal.show { display: flex; }
  </style>
</head>

<body class="p-4">
  <header class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-blue-600">Diagn√≥stico Funcional ‚Äî Ciente IE</h1>
    <nav class="flex gap-2">
      <span class="aba active" id="abaAtletas" onclick="mostrarAba('atletas')">Atletas</span>
      <span class="aba" id="abaDiagnostico" onclick="mostrarAba('diagnostico')">Diagn√≥stico</span>
      <span class="aba" id="abaTreinos" onclick="mostrarAba('treinos')">Treinos Sugeridos</span>
      <span class="aba" id="abaHistorico" onclick="mostrarAba('historico')">Atividades Extra</span>
    </nav>
  </header>

  <!-- üßç ATLETAS -->
  <section id="aba-atletas">
    <h2 class="text-lg font-semibold mb-3 text-blue-600">Selecione um atleta</h2>
    <div class="flex gap-3 items-center mb-4">
      <select id="selectAtleta" class="p-2 border rounded-md min-w-[250px]">
        <option value="">-- Escolha o atleta --</option>
      </select>
      <button id="btnNovoDiag" class="btn hidden" onclick="abrirDiagnostico()">Cadastrar Diagn√≥stico</button>
    </div>
  </section>

  <!-- ü©∫ DIAGN√ìSTICO -->
  <section id="aba-diagnostico" class="hidden">
    <h2 class="text-lg font-semibold mb-2 text-blue-600">Cadastrar Diagn√≥stico</h2>
    <p id="nomeAtletaSel" class="text-sm mb-4 text-gray-600 italic"></p>

    <form id="formDiagnostico" class="space-y-4">
      <div class="card">
        <h3 class="font-semibold mb-2">Assimetria Muscular (Rela√ß√£o Isquiotibiais / Quadr√≠ceps)</h3>
        <div class="flex gap-4">
          <label><input type="checkbox" name="hq" value="Direita"> Perna Direita</label>
          <label><input type="checkbox" name="hq" value="Esquerda"> Perna Esquerda</label>
        </div>
      </div>

      <div class="card">
        <h3 class="font-semibold mb-2">Assimetria Muscular (Diferen√ßa entre Pernas)</h3>
        <div class="flex gap-4 mb-2">
          <label><input type="checkbox" name="perna" value="Direita"> Direita</label>
          <label><input type="checkbox" name="perna" value="Esquerda"> Esquerda</label>
        </div>
        <div class="flex flex-wrap gap-4">
          <label><input type="checkbox" name="musculo" value="Isquiotibiais"> Isquiotibiais</label>
          <label><input type="checkbox" name="musculo" value="Quadr√≠ceps"> Quadr√≠ceps</label>
          <label><input type="checkbox" name="musculo" value="Gastrocn√™mio"> Gastrocn√™mio</label>
          <label><input type="checkbox" name="musculo" value="Gl√∫teo"> Gl√∫teo</label>
        </div>
      </div>

      <div class="card">
        <h3 class="font-semibold mb-2">Baixa Mobilidade</h3>
        <div class="flex flex-wrap gap-4 mb-2">
          <label><input type="checkbox" name="mobilidade" value="Quadril"> Quadril</label>
          <label><input type="checkbox" name="mobilidade" value="Joelho"> Joelho</label>
          <label><input type="checkbox" name="mobilidade" value="Tornozelo"> Tornozelo</label>
        </div>
        <div class="flex gap-4">
          <label><input type="checkbox" name="lado-mob" value="Direita"> Direita</label>
          <label><input type="checkbox" name="lado-mob" value="Esquerda"> Esquerda</label>
        </div>
      </div>

      <div class="card">
        <h3 class="font-semibold mb-2">Encurtamento Muscular</h3>
        <div class="flex flex-wrap gap-4 mb-2">
          <label><input type="checkbox" name="encurtamento" value="Lombar"> Lombar</label>
          <label><input type="checkbox" name="encurtamento" value="Isquiotibiais"> Isquiotibiais</label>
          <label><input type="checkbox" name="encurtamento" value="Quadr√≠ceps"> Quadr√≠ceps</label>
          <label><input type="checkbox" name="encurtamento" value="Gastrocn√™mio"> Gastrocn√™mio</label>
          <label><input type="checkbox" name="encurtamento" value="Gl√∫teo"> Gl√∫teo</label>
        </div>
        <div class="flex gap-4">
          <label><input type="checkbox" name="lado-enc" value="Direita"> Direita</label>
          <label><input type="checkbox" name="lado-enc" value="Esquerda"> Esquerda</label>
        </div>
      </div>

      <div class="flex gap-3">
        <button type="button" class="btn" onclick="gerarTreinoAutomatico()">Gerar Treino Sugerido</button>
        <button type="button" class="btn bg-gray-400 hover:bg-gray-500" onclick="mostrarAba('atletas')">Cancelar</button>
      </div>
    </form>
  </section>

  <!-- üí™ TREINOS -->
  <section id="aba-treinos" class="hidden">
    <h2 class="text-lg font-semibold mb-3 text-blue-600">Treino Oficial</h2>
    <div id="treinoOficial" class="space-y-3 mb-6"></div>

    <h2 class="text-lg font-semibold mb-3 text-blue-600">Outros Exerc√≠cios Dispon√≠veis</h2>
    <div id="catalogoExercicios" class="space-y-3 mb-6"></div>

    <div class="flex gap-3">
      <button class="btn" onclick="adicionarExercicioManual()">+ Novo Exerc√≠cio</button>
      <button class="btn bg-green-600 hover:bg-green-700" onclick="salvarTreino()">Salvar Treino</button>
    </div>
  </section>

  <!-- üìú HIST√ìRICO -->
<section id="aba-historico" class="hidden">
  <h2 class="text-lg font-semibold mb-3 text-blue-600">Atividades Extra</h2>

  <div class="overflow-x-auto bg-white rounded-lg shadow-md">
    <table class="min-w-full border-collapse">
      <thead class="bg-blue-50 border-b">
        <tr>
          <th class="py-2 px-4 text-left text-sm font-semibold text-gray-700">Atleta</th>
          <th class="py-2 px-4 text-left text-sm font-semibold text-gray-700">Data</th>
          <th class="py-2 px-4 text-left text-sm font-semibold text-gray-700">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaHistorico" class="divide-y divide-gray-200 text-sm text-gray-700">
        <!-- Linhas carregadas dinamicamente -->
      </tbody>
    </table>
  </div>
</section>

  <!-- MODAL -->
  <div id="modalDetalhes" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
    <div id="modalConteudo" class="bg-white rounded-lg p-4 max-w-lg w-full max-h-[80vh] overflow-y-auto"></div>
  </div>

<script>
/* üî• Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyDsoutLk5gmxq5zlu548HWFrox37u1zrxk",
  authDomain: "appintegrado-ciente.firebaseapp.com",
  projectId: "appintegrado-ciente",
  storageBucket: "appintegrado-ciente.appspot.com",
  messagingSenderId: "487559108410",
  appId: "1:487559108410:web:08868011454e609ee52203"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ‚öôÔ∏è Estado */
let atletaSelecionado = null;
let treinoGerado = [];
const IMG_BASE = "https://ciente-ie.github.io/avaliacoes/img/exercicios/";

/* üß≠ Abas */
function mostrarAba(nome){
  ["atletas","diagnostico","treinos","historico"].forEach(a=>{
    document.getElementById("aba-"+a).classList.add("hidden");
    document.getElementById("aba"+a.charAt(0).toUpperCase()+a.slice(1)).classList.remove("active");
  });
  document.getElementById("aba-"+nome).classList.remove("hidden");
  document.getElementById("aba"+nome.charAt(0).toUpperCase()+nome.slice(1)).classList.add("active");
  if(nome==="historico") carregarHistorico();
  if(nome==="treinos"){ renderTreinoGerado(); renderCatalogo(); }
}

async function carregarAtletas(){
  const snap = await db.collection("prontidao").get();
  const select = document.getElementById("selectAtleta");
  select.innerHTML = '<option value="">-- Escolha o atleta --</option>';
  const nomes = new Set();
  snap.forEach(doc=>{
    const a = doc.data();
    if(a.nome_atleta && !nomes.has(a.nome_atleta)){
      nomes.add(a.nome_atleta);
      const op = document.createElement("option");
      op.value = doc.id;
      op.textContent = a.nome_atleta;
      select.appendChild(op);
    }
  });
}
window.onload = carregarAtletas;

document.getElementById("selectAtleta").addEventListener("change", ()=>{
  const nome = document.querySelector("#selectAtleta option:checked").textContent;
  atletaSelecionado = nome || null;
  document.getElementById("btnNovoDiag").classList.toggle("hidden", !atletaSelecionado);
});

function abrirDiagnostico(){
  if(!atletaSelecionado){ alert("Selecione um atleta primeiro."); return; }
  document.getElementById("nomeAtletaSel").textContent = "Atleta selecionado: " + atletaSelecionado;
  mostrarAba("diagnostico");
}

/* üèãÔ∏è Banco de exerc√≠cios */
const exerciciosBase = {
  "Quadril": [
    {nome:"90/90 Mobilidade", tipo:"mobilidade", series:"3x10", freq:"2x/semana"},
    {nome:"Cossack Squat", tipo:"mobilidade", series:"3x10", freq:"2x/semana"},
    {nome:"Ponte Unilateral", tipo:"unilateral", series:"3x10", freq:"2x/semana"},
    {nome:"Alongamento Pigeon", tipo:"alongamento", series:"3x30s", freq:"2x/semana"}
  ],
  "Joelho": [
    {nome:"Isometria na Parede", tipo:"isometrico", series:"3x30s", freq:"2x/semana"},
    {nome:"Step-up Unilateral", tipo:"unilateral", series:"3x10", freq:"2x/semana"},
    {nome:"Lunge Est√°tico", tipo:"isometrico", series:"3x30s", freq:"2x/semana"},
    {nome:"Alongamento de Quadr√≠ceps", tipo:"alongamento", series:"3x30s", freq:"2x/semana"}
  ],
  "Tornozelo": [
    {nome:"Mobiliza√ß√£o de Tornozelo", tipo:"mobilidade", series:"3x15", freq:"2x/semana"},
    {nome:"Equil√≠brio Unipodal", tipo:"unilateral", series:"3x30s", freq:"2x/semana"},
    {nome:"Alongamento de Panturrilha", tipo:"alongamento", series:"3x30s", freq:"2x/semana"}
  ],
  "Gl√∫teo": [
    {nome:"Ponte de Gl√∫teo Unilateral", tipo:"unilateral", series:"3x10", freq:"2x/semana"},
    {nome:"Abdu√ß√£o com El√°stico", tipo:"isometrico", series:"3x30s", freq:"2x/semana"},
    {nome:"Couch Stretch", tipo:"alongamento", series:"3x30s", freq:"2x/semana"}
  ],
  "Isquiotibiais": [
    {nome:"Nordic Curl", tipo:"isometrico", series:"3x8", freq:"2x/semana"},
    {nome:"Good Morning Unilateral", tipo:"unilateral", series:"3x10", freq:"2x/semana"},
    {nome:"Alongamento Isquiotibiais", tipo:"alongamento", series:"3x30s", freq:"2x/semana"}
  ],
  "Lombar": [
    {nome:"Prancha Est√°tica", tipo:"isometrico", series:"3x30s", freq:"2x/semana"},
    {nome:"Bird Dog", tipo:"unilateral", series:"3x12", freq:"2x/semana"},
    {nome:"Alongamento Lombar", tipo:"alongamento", series:"3x30s", freq:"2x/semana"}
  ]
};

/* üéØ L√≥gica inteligente */
function escolherPorDiagnostico(cat, tipoDiagnostico){
  const lista = exerciciosBase[cat] || [];
  if(!lista.length) return [];
  let prioridade = [];
  if(tipoDiagnostico==="mobilidade") prioridade = ["mobilidade","unilateral"];
  else if(tipoDiagnostico==="encurtamento") prioridade = ["alongamento","mobilidade"];
  else prioridade = ["unilateral","isometrico","mobilidade"];
  const escolhidos = [];
  for(const tipo of prioridade){
    const candidatos = lista.filter(e=>e.tipo===tipo && !escolhidos.includes(e));
    while(candidatos.length && escolhidos.length<2){
      const i = Math.floor(Math.random()*candidatos.length);
      escolhidos.push(candidatos.splice(i,1)[0]);
    }
    if(escolhidos.length>=2) break;
  }
  return escolhidos;
}

/* ü§ñ Gera√ß√£o autom√°tica */
function gerarTreinoAutomatico(){
  const form = new FormData(document.getElementById("formDiagnostico"));
  const selecionadas = new Map();

  // HQ
  if(form.getAll("hq").length){
    selecionadas.set("Isquiotibiais","assimetria");
    selecionadas.set("Quadr√≠ceps","assimetria");
  }
  // Diferen√ßa entre pernas
  form.getAll("musculo").forEach(m=>selecionadas.set(m,"assimetria"));
  // Mobilidade
  form.getAll("mobilidade").forEach(m=>{
    const map = {Quadril:"Quadril", Joelho:"Joelho", Tornozelo:"Tornozelo"};
    selecionadas.set(map[m],"mobilidade");
  });
  // Encurtamento
  form.getAll("encurtamento").forEach(m=>selecionadas.set(m,"encurtamento"));

  if(!selecionadas.size){ alert("Selecione ao menos um item no diagn√≥stico."); return; }

  treinoGerado = [];
  selecionadas.forEach((tipo,cat)=>{
    const dois = escolherPorDiagnostico(cat,tipo);
    if(dois.length) treinoGerado.push({categoria:cat,exercicios:dois});
  });
  mostrarAba("treinos");
}

/* üßæ Renderiza√ß√£o */
function renderTreinoGerado(){
  const div = document.getElementById("treinoOficial");
  div.innerHTML = "";
  treinoGerado.forEach((g,i)=>{
    let html = `<div class='card'><h3 class='text-blue-600 font-semibold mb-2'>${g.categoria}</h3>`;
    g.exercicios.forEach((e,j)=>{
      html += `<div class='flex justify-between items-center border-b py-2'>
      <div><p class='font-semibold'>${e.nome}</p><p class='text-sm text-gray-600'>${e.series} ‚Äî ${e.freq}</p></div>
      <button class='text-red-500 font-bold' onclick='removerExercicio(${i},${j})'>‚ùå</button></div>`;
    });
    html+="</div>";
    div.innerHTML+=html;
  });
}
function removerExercicio(i,j){
  treinoGerado[i].exercicios.splice(j,1);
  if(!treinoGerado[i].exercicios.length) treinoGerado.splice(i,1);
  renderTreinoGerado();
}

/* üìò Cat√°logo */
function renderCatalogo(){
  const div=document.getElementById("catalogoExercicios");
  div.innerHTML="";
  Object.entries(exerciciosBase).forEach(([cat,lista])=>{
    let html=`<div class='card'><h3 class='text-blue-600 font-semibold mb-2'>${cat}</h3>`;
    lista.forEach((e,i)=>{
      html+=`<div class='flex justify-between items-center border-b py-1'>
        <p class='text-sm'>${e.nome}</p>
        <button class='text-green-600 font-bold' onclick='adicionarAoTreino("${cat}",${i})'>‚ûï</button></div>`;
    });
    html+="</div>";
    div.innerHTML+=html;
  });
}
function adicionarAoTreino(cat,i){
  const ex=exerciciosBase[cat][i];
  let g=treinoGerado.find(t=>t.categoria===cat);
  if(!g){g={categoria:cat,exercicios:[]};treinoGerado.push(g);}
  if(!g.exercicios.find(x=>x.nome===ex.nome)){g.exercicios.push(ex);renderTreinoGerado();}
}
function adicionarExercicioManual(){
  const cat=prompt("Categoria:"); const nome=prompt("Nome do exerc√≠cio:");
  const tipo=prompt("Tipo (unilateral/isometrico/mobilidade/alongamento):","unilateral");
  const series=prompt("S√©ries:", "3x10"); const freq=prompt("Frequ√™ncia:","2x/semana");
  if(!cat||!nome)return; if(!exerciciosBase[cat])exerciciosBase[cat]=[];
  exerciciosBase[cat].push({nome,tipo,series,freq}); renderCatalogo();
}

/* üíæ Salvar Treino */
async function salvarTreino(){
  if(!atletaSelecionado){alert("Selecione um atleta.");return;}
  if(!treinoGerado.length){alert("Gere o treino primeiro.");return;}
  await db.collection("treinos_extras").add({
    nome_atleta:atletaSelecionado,
    data:new Date().toLocaleDateString("pt-BR"),
    treino_gerado:treinoGerado
  });
  alert("‚úÖ Treino salvo!"); mostrarAba("historico");
}

/* üìú Hist√≥rico + Modal */
const modalCache={};
async function carregarHistorico(){
  const snap=await db.collection("treinos_extras").get();
  const t=document.getElementById("tabelaHistorico");
  t.innerHTML="";
  snap.forEach(doc=>{
    const d=doc.data();
    t.innerHTML+=`<tr><td>${d.nome_atleta}</td><td>${d.data}</td>
      <td><button class='text-blue-600' onclick='abrirModal("${doc.id}")'>Ver Detalhes</button>
      <button class='text-red-600 ml-3' onclick='excluirTreino("${doc.id}")'>Excluir</button></td></tr>`;
    modalCache[doc.id]=d;
  });
}
function slugImagem(nome){
  return nome.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/\s+/g,"_")+".jpg";
}
function abrirModal(id){
  const x=modalCache[id]; if(!x)return;
  let html=`<h2 class='text-xl font-bold text-blue-600 mb-2'>${x.nome_atleta}</h2><p class='text-sm text-gray-600 mb-3'>${x.data}</p>`;
  (x.treino_gerado||[]).forEach(cat=>{
    html+=`<h3 class='font-semibold text-blue-600 mt-3 mb-2'>${cat.categoria}</h3>`;
    (cat.exercicios||[]).forEach(e=>{
      html+=`<div class='mb-3'><img src='${IMG_BASE+slugImagem(e.nome)}' class='w-full rounded mb-1' onerror="this.style.display='none'">
      <p class='font-semibold'>${e.nome}</p><p class='text-sm text-gray-600'>${e.series} ‚Äî ${e.freq}</p></div>`;
    });
  });
  html+="<button class='btn w-full mt-3' onclick='fecharModal()'>Fechar</button>";
  document.getElementById("modalConteudo").innerHTML=html;
  document.getElementById("modalDetalhes").classList.add("show");
}
function fecharModal(){document.getElementById("modalDetalhes").classList.remove("show");}
document.getElementById("modalDetalhes").addEventListener("click",e=>{if(e.target.id==="modalDetalhes")fecharModal();});
async function excluirTreino(id){if(confirm("Excluir treino?")){await db.collection("treinos_extras").doc(id).delete();carregarHistorico();}}
</script>
</body>
</html>
