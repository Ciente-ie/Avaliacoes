<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Diagnóstico Funcional - Ciente IE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <style>
    body{font-family:'Inter',sans-serif;background:#f8fafc}
    .aba{cursor:pointer;padding:.75rem 1.5rem;border-radius:9999px;transition:.2s}
    .aba.active{background-color:#2563eb;color:#fff}
    .card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);padding:1rem;margin-bottom:1rem}
    .btn{background-color:#2563eb;color:#fff;padding:.5rem 1rem;border-radius:8px;cursor:pointer;transition:.2s}
    .btn:hover{background-color:#1d4ed8}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.75rem;text-align:left;border-bottom:1px solid #e5e7eb}
    th{background-color:#eff6ff;color:#1e3a8a}
    tr:nth-child(even){background-color:#f9fafb}
    .modal{display:none}
    .modal.show{display:flex}
  </style>
</head>
<body class="p-4">
  <header class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-blue-600">Diagnóstico Funcional — Ciente IE</h1>
    <nav class="flex gap-2">
      <span class="aba active" id="abaAtletas" onclick="mostrarAba('atletas')">Atletas</span>
      <span class="aba" id="abaDiagnostico" onclick="mostrarAba('diagnostico')">Diagnóstico</span>
      <span class="aba" id="abaTreinos" onclick="mostrarAba('treinos')">Treinos Sugeridos</span>
      <span class="aba" id="abaHistorico" onclick="mostrarAba('historico')">Atividades Extra</span>
    </nav>
  </header>

  <!-- ABA ATLETAS -->
  <section id="aba-atletas">
    <h2 class="text-lg font-semibold mb-3 text-blue-600">Selecione um atleta</h2>
    <div class="flex gap-3 items-center mb-4">
      <select id="selectAtleta" class="p-2 border rounded-md min-w-[260px]">
        <option value="">-- Escolha o atleta --</option>
      </select>
      <button id="btnNovoDiag" class="btn hidden" onclick="abrirDiagnostico()">Cadastrar Diagnóstico</button>
    </div>
  </section>

  <!-- ABA DIAGNÓSTICO -->
  <section id="aba-diagnostico" class="hidden">
    <h2 class="text-lg font-semibold mb-2 text-blue-600">Cadastrar Diagnóstico</h2>
    <p id="nomeAtletaSel" class="text-sm mb-4 text-gray-600 italic"></p>

    <form id="formDiagnostico" class="space-y-4">
      <!-- Assimetria Relação HQ -->
      <div class="card">
        <h3 class="font-semibold mb-2">Assimetria Muscular (Relação Isquiotibiais / Quadríceps)</h3>
        <div class="flex gap-4">
          <label><input type="checkbox" name="hq" value="Direita"> Perna Direita</label>
          <label><input type="checkbox" name="hq" value="Esquerda"> Perna Esquerda</label>
        </div>
        <p class="text-xs text-gray-500 mt-1">Obs.: aqui só lado (Direita/Esquerda).</p>
      </div>

      <!-- Assimetria Diferença Entre Pernas -->
      <div class="card">
        <h3 class="font-semibold mb-2">Assimetria Muscular (Diferença entre Pernas)</h3>
        <div class="flex gap-4 mb-2">
          <label><input type="checkbox" name="perna" value="Direita"> Direita</label>
          <label><input type="checkbox" name="perna" value="Esquerda"> Esquerda</label>
        </div>
        <div class="flex flex-wrap gap-4">
          <label><input type="checkbox" name="musculo" value="Isquiotibiais"> Isquiotibiais</label>
          <label><input type="checkbox" name="musculo" value="Quadríceps"> Quadríceps</label>
          <label><input type="checkbox" name="musculo" value="Gastrocnêmio"> Gastrocnêmio</label>
          <label><input type="checkbox" name="musculo" value="Glúteo"> Glúteo</label>
        </div>
      </div>

      <!-- Baixa Mobilidade -->
      <div class="card">
        <h3 class="font-semibold mb-2">Baixa Mobilidade</h3>
        <div class="flex flex-wrap gap-4 mb-2">
          <label><input type="checkbox" name="mobilidade" value="Quadril"> Quadril</label>
          <label><input type="checkbox" name="mobilidade" value="Joelho"> Joelho</label>
          <label><input type="checkbox" name="mobilidade" value="Tornozelo"> Tornozelo</label>
        </div>
        <div class="flex gap-4">
          <label><input type="checkbox" name="lado-mob" value="Direita"> Direita</label>
          <label><input type="checkbox" name="lado-mob" value="Esquerda"> Esquerda</label>
        </div>
      </div>

      <!-- Encurtamento Muscular -->
      <div class="card">
        <h3 class="font-semibold mb-2">Encurtamento Muscular</h3>
        <div class="flex flex-wrap gap-4 mb-2">
          <label><input type="checkbox" name="encurtamento" value="Lombar"> Lombar</label>
          <label><input type="checkbox" name="encurtamento" value="Isquiotibiais"> Isquiotibiais</label>
          <label><input type="checkbox" name="encurtamento" value="Quadríceps"> Quadríceps</label>
          <label><input type="checkbox" name="encurtamento" value="Gastrocnêmio"> Gastrocnêmio</label>
          <label><input type="checkbox" name="encurtamento" value="Glúteo"> Glúteo</label>
        </div>
        <div class="flex gap-4">
          <label><input type="checkbox" name="lado-enc" value="Direita"> Direita</label>
          <label><input type="checkbox" name="lado-enc" value="Esquerda"> Esquerda</label>
        </div>
      </div>

      <div class="flex gap-3">
        <button type="button" class="btn" onclick="gerarTreinoAutomatico()">Gerar Treino Sugerido</button>
        <button type="button" class="btn bg-gray-400 hover:bg-gray-500" onclick="mostrarAba('atletas')">Cancelar</button>
      </div>
    </form>
  </section>

  <!-- ABA TREINOS SUGERIDOS -->
  <section id="aba-treinos" class="hidden">
    <h2 class="text-lg font-semibold mb-3 text-blue-600">Treino Oficial (gerado automaticamente)</h2>
    <div id="treinoOficial" class="space-y-3 mb-6"></div>

    <h2 class="text-lg font-semibold mb-3 text-blue-600">Outros Exercícios Disponíveis</h2>
    <div id="catalogoExercicios" class="space-y-3 mb-6"></div>

    <div class="flex gap-3">
      <button class="btn" onclick="adicionarExercicioManual()">+ Novo Exercício</button>
      <button class="btn bg-green-600 hover:bg-green-700" onclick="salvarTreino()">Salvar Treino</button>
    </div>
  </section>

  <!-- ABA ATIVIDADES EXTRA -->
  <section id="aba-historico" class="hidden">
    <h2 class="text-lg font-semibold mb-3 text-blue-600">Atividades Extra</h2>
    <table>
      <thead>
        <tr><th>Atleta</th><th>Data</th><th>Ações</th></tr>
      </thead>
      <tbody id="tabelaHistorico"></tbody>
    </table>
  </section>

  <!-- MODAL DETALHES -->
  <div id="modalDetalhes" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
    <div id="modalConteudo" class="bg-white rounded-lg p-4 max-w-lg w-full max-h-[80vh] overflow-y-auto"></div>
  </div>

  <footer class="text-center mt-8 text-sm text-gray-500">
    Powered by <span class="font-semibold text-blue-600">Ciente IE</span>
  </footer>

<script>
/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDsoutLk5gmxq5zlu548HWFrox37u1zrxk",
  authDomain: "appintegrado-ciente.firebaseapp.com",
  projectId: "appintegrado-ciente",
  storageBucket: "appintegrado-ciente.appspot.com",
  messagingSenderId: "487559108410",
  appId: "1:487559108410:web:08868011454e609ee52203"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== Estado global ===== */
let atletaSelecionado = null;
let treinoGerado = []; // [{ categoria, exercicios:[{nome, series, freq, tipo}] }]
const IMG_BASE = "https://ciente-ie.github.io/avaliacoes/img/exercicios/";

/* ===== Util ===== */
function mostrarAba(nome){
  ["atletas","diagnostico","treinos","historico"].forEach(a=>{
    document.getElementById("aba-"+a).classList.add("hidden");
    document.getElementById("aba"+a.charAt(0).toUpperCase()+a.slice(1)).classList.remove("active");
  });
  document.getElementById("aba-"+nome).classList.remove("hidden");
  document.getElementById("aba"+nome.charAt(0).toUpperCase()+nome.slice(1)).classList.add("active");
  if(nome==="historico") carregarHistorico();
  if(nome==="treinos"){ renderTreinoGerado(); renderCatalogo(); }
}

async function carregarAtletas(){
  const snap = await db.collection("prontidao").get();
  const select = document.getElementById("selectAtleta");
  select.innerHTML = '<option value="">-- Escolha o atleta --</option>';
  const nomes = new Set();
  snap.forEach(doc=>{
    const a = doc.data();
    if(a.nome_atleta && !nomes.has(a.nome_atleta)){
      nomes.add(a.nome_atleta);
      const op = document.createElement("option");
      op.value = doc.id;
      op.textContent = a.nome_atleta;
      select.appendChild(op);
    }
  });
}
window.onload = carregarAtletas;

document.getElementById("selectAtleta").addEventListener("change", ()=>{
  const nome = document.querySelector("#selectAtleta option:checked").textContent;
  atletaSelecionado = nome || null;
  document.getElementById("btnNovoDiag").classList.toggle("hidden", !atletaSelecionado);
});

function abrirDiagnostico(){
  if(!atletaSelecionado){ alert("Selecione um atleta primeiro."); return; }
  document.getElementById("nomeAtletaSel").textContent = "Atleta selecionado: " + atletaSelecionado;
  mostrarAba("diagnostico");
}

/* ===== Banco ~40 exercícios (prioriza unilaterais / isométricos / mobilidade com força) ===== */
const exerciciosBase = {
  "Quadril": [
    {nome:"90/90 Mobilidade", tipo:"mobilidade", series:"3x10", freq:"2x/semana"},
    {nome:"Ponte Unilateral", tipo:"unilateral", series:"3x10", freq:"2x/semana"},
    {nome:"Cossack Squat", tipo:"mobilidade", series:"3x10", freq:"2x/semana"},
    {nome:"Abdução com Elástico", tipo:"isometrico", series:"3x30s", freq:"2x/semana"},
    {nome:"Elevação Pélvica Unilateral", tipo:"unilateral", series:"3x12", freq:"2x/semana"}
  ],
  "Joelho": [
    {nome:"Isometria na Parede", tipo:"isometrico", series:"3x30s", freq:"2x/semana"},
    {nome:"Step-up Unilateral", tipo:"unilateral", series:"3x10", freq:"2x/semana"},
    {nome:"Lunge Estático", tipo:"isometrico", series:"3x30s", freq:"2x/semana"},
    {nome:"Agachamento Unilateral", tipo:"unilateral", series:"3x8", freq:"2x/semana"},
    {nome:"Split Squat", tipo:"unilateral", series:"3x8", freq:"2x/semana"}
  ],
  "Tornozelo": [
    {nome:"Ponte de Panturrilha Unilateral", tipo:"unilateral", series:"3x15", freq:"2x/semana"},
    {nome:"Mobilização de Tornozelo", tipo:"mobilidade", series:"3x15", freq:"2x/semana"},
    {nome:"Isometria de Panturrilha", tipo:"isometrico", series:"3x30s", freq:"2x/semana"},
    {nome:"Equilíbrio Unipodal", tipo:"unilateral", series:"3x30s", freq:"2x/semana"},
    {nome:"Alcance em Y Unipodal", tipo:"unilateral", series:"3x8", freq:"2x/semana"}
  ],
  "Glúteo": [
    {nome:"Ponte de Glúteo Unilateral", tipo:"unilateral", series:"3x10", freq:"2x/semana"},
    {nome:"Clamshell", tipo:"unilateral", series:"3x15", freq:"2x/semana"},
    {nome:"Abdução com Elástico", tipo:"isometrico", series:"3x30s", freq:"2x/semana"},
    {nome:"Kickback de Glúteo", tipo:"mobilidade", series:"3x12", freq:"2x/semana"},
    {nome:"Passada Lateral com Mini Band", tipo:"mobilidade", series:"3x12", freq:"2x/semana"}
  ],
  "Quadríceps": [
    {nome:"Couch Stretch", tipo:"mobilidade", series:"3x30s", freq:"2x/semana"},
    {nome:"Agachamento Isométrico", tipo:"isometrico", series:"3x40s", freq:"2x/semana"},
    {nome:"Lunge Lateral", tipo:"mobilidade", series:"3x10", freq:"2x/semana"},
    {nome:"Step-down Unilateral", tipo:"unilateral", series:"3x8", freq:"2x/semana"},
    {nome:"Split Squat Búlgaro", tipo:"unilateral", series:"3x8", freq:"2x/semana"}
  ],
  "Isquiotibiais": [
    {nome:"Nordic Curl Parcial", tipo:"isometrico", series:"3x8", freq:"2x/semana"},
    {nome:"Good Morning Unilateral", tipo:"unilateral", series:"3x10", freq:"2x/semana"},
    {nome:"Flexão Nórdica Isométrica", tipo:"isometrico", series:"3x20s", freq:"2x/semana"},
    {nome:"Peso Morto Unilateral", tipo:"unilateral", series:"3x8", freq:"2x/semana"},
    {nome:"Bridge Walkouts", tipo:"mobilidade", series:"3x8", freq:"2x/semana"}
  ],
  "Gastrocnêmio": [
    {nome:"Alongamento de Panturrilha", tipo:"mobilidade", series:"3x30s", freq:"2x/semana"},
    {nome:"Elevação de Panturrilha Unilateral", tipo:"unilateral", series:"3x15", freq:"2x/semana"},
    {nome:"Isometria de Panturrilha em Pé", tipo:"isometrico", series:"3x30s", freq:"2x/semana"},
    {nome:"Panturrilha Excêntrica Unilateral", tipo:"unilateral", series:"3x12", freq:"2x/semana"}
  ],
  "Lombar": [
    {nome:"Prancha Estática", tipo:"isometrico", series:"3x30s", freq:"2x/semana"},
    {nome:"Bird Dog", tipo:"unilateral", series:"3x12", freq:"2x/semana"},
    {nome:"Extensão Lombar Isométrica", tipo:"isometrico", series:"3x20s", freq:"2x/semana"},
    {nome:"Superman Controlado", tipo:"mobilidade", series:"3x12", freq:"2x/semana"},
    {nome:"Side Plank (Lateral)", tipo:"isometrico", series:"3x25s", freq:"2x/semana"}
  ]
};

/* ===== Sorteio com prioridade (unilateral > isometrico > mobilidade) ===== */
function escolherDoisDaCategoria(cat){
  const lista = exerciciosBase[cat] || [];
  if(!lista.length) return [];
  const prioridade = ["unilateral","isometrico","mobilidade"];
  const escolhidos = [];
  for(const tipo of prioridade){
    const candidatos = lista.filter(e=>e.tipo===tipo && !escolhidos.includes(e));
    while(candidatos.length && escolhidos.length<2){
      const i = Math.floor(Math.random()*candidatos.length);
      const ex = candidatos.splice(i,1)[0];
      if(!escolhidos.find(x=>x.nome===ex.nome)) escolhidos.push(ex);
    }
    if(escolhidos.length>=2) break;
  }
  // Se ainda faltou, completa com qualquer um diferente
  let pool = lista.filter(e=>!escolhidos.find(x=>x.nome===e.nome));
  while(escolhidos.length<2 && pool.length){
    const i = Math.floor(Math.random()*pool.length);
    escolhidos.push(pool.splice(i,1)[0]);
  }
  return escolhidos;
}

/* ===== Geração do Treino a partir do Diagnóstico ===== */
function gerarTreinoAutomatico(){
  const form = new FormData(document.getElementById("formDiagnostico"));
  const selecionadas = new Set();

  // HQ → afeta Isquiotibiais e Quadríceps
  if(form.getAll("hq").length){ selecionadas.add("Isquiotibiais"); selecionadas.add("Quadríceps"); }

  // Diferença entre Pernas (músculos marcados)
  form.getAll("musculo").forEach(m=> selecionadas.add(m));

  // Baixa Mobilidade
  form.getAll("mobilidade").forEach(m=> {
    // mapear termos para categorias
    if(m==="Quadril") selecionadas.add("Quadril");
    if(m==="Joelho") selecionadas.add("Joelho");
    if(m==="Tornozelo") selecionadas.add("Tornozelo");
  });

  // Encurtamento
  form.getAll("encurtamento").forEach(m=> selecionadas.add(m));

  if(!selecionadas.size){
    alert("Selecione pelo menos um item no diagnóstico.");
    return;
  }

  // Monta treino
  treinoGerado = [];
  selecionadas.forEach(cat=>{
    const dois = escolherDoisDaCategoria(cat);
    if(dois.length){
      treinoGerado.push({categoria:cat, exercicios:dois});
    }
  });

  mostrarAba("treinos");
}

/* ===== Render Treino Oficial ===== */
function renderTreinoGerado(){
  const div = document.getElementById("treinoOficial");
  div.innerHTML = "";
  if(!treinoGerado.length){
    div.innerHTML = `<p class="text-gray-500 text-sm">Nenhum exercício sugerido ainda. Gere a partir do diagnóstico.</p>`;
    return;
  }
  treinoGerado.forEach((grupo,i)=>{
    let html = `<div class="card"><h3 class="text-blue-600 font-semibold mb-2">${grupo.categoria}</h3>`;
    grupo.exercicios.forEach((e,j)=>{
      html += `<div class="flex justify-between items-center border-b py-2">
        <div><p class="font-semibold">${e.nome}</p><p class="text-sm text-gray-600">${e.series} — ${e.freq}</p></div>
        <button class="text-red-500 font-bold" onclick="removerExercicio(${i},${j})">❌</button>
      </div>`;
    });
    html += `</div>`;
    div.innerHTML += html;
  });
}
function removerExercicio(i,j){
  treinoGerado[i].exercicios.splice(j,1);
  if(!treinoGerado[i].exercicios.length) treinoGerado.splice(i,1);
  renderTreinoGerado();
}

/* ===== Render Catálogo ===== */
function renderCatalogo(){
  const div = document.getElementById("catalogoExercicios");
  div.innerHTML = "";
  Object.entries(exerciciosBase).forEach(([cat,lista])=>{
    let html = `<div class="card"><h3 class="text-blue-600 font-semibold mb-2">${cat}</h3>`;
    lista.forEach((e,idx)=>{
      html += `<div class="flex justify-between items-center border-b py-1">
        <p class="text-sm">${e.nome}</p>
        <button class="text-green-600 font-bold" onclick="adicionarAoTreino('${cat}',${idx})">➕</button>
      </div>`;
    });
    html += `</div>`;
    div.innerHTML += html;
  });
}
function adicionarAoTreino(cat, idx){
  const ex = exerciciosBase[cat][idx];
  let grupo = treinoGerado.find(g=>g.categoria===cat);
  if(!grupo){ grupo = {categoria:cat, exercicios:[]}; treinoGerado.push(grupo); }
  // evita duplicar mesmo exercício pelo nome
  if(!grupo.exercicios.find(x=>x.nome===ex.nome)){
    grupo.exercicios.push(ex);
    renderTreinoGerado();
  }
}
function adicionarExercicioManual(){
  const categoria = prompt("Categoria (ex: Joelho, Glúteo, etc.):");
  const nome = prompt("Nome do exercício:");
  const tipo = prompt("Tipo (unilateral / isometrico / mobilidade):","unilateral");
  const series = prompt("Séries e repetições/tempo (ex: 3x10 ou 3x30s):","3x10");
  const freq = prompt("Frequência semanal (ex: 2x/semana):","2x/semana");
  if(!categoria || !nome) return;
  if(!exerciciosBase[categoria]) exerciciosBase[categoria] = [];
  exerciciosBase[categoria].push({nome, tipo:(tipo||"unilateral"), series, freq});
  renderCatalogo();
}

/* ===== Salvar Treino ===== */
async function salvarTreino(){
  if(!atletaSelecionado){ alert("Selecione um atleta primeiro."); return; }
  if(!treinoGerado.length){ alert("Gere/adicione exercícios antes de salvar."); return; }
  const dado = {
    nome_atleta: atletaSelecionado,
    data: new Date().toLocaleDateString("pt-BR"),
    treino_gerado: treinoGerado
  };
  await db.collection("treinos_extras").add(dado);
  alert("✅ Treino salvo com sucesso!");
  mostrarAba("historico");
}

/* ===== Histórico + Modal ===== */
const modalCache = {};
async function carregarHistorico(){
  const t = document.getElementById("tabelaHistorico");
  t.innerHTML = "";
  const snap = await db.collection("treinos_extras").get();
  snap.forEach(doc=>{
    const x = doc.data();
    t.innerHTML += `
      <tr>
        <td>${x.nome_atleta||"-"}</td>
        <td>${x.data||"-"}</td>
        <td>
          <button class="text-blue-600 underline" onclick="abrirModal('${doc.id}')">Ver Detalhes</button>
          <button class="text-red-600 underline ml-3" onclick="excluirTreino('${doc.id}')">Excluir</button>
        </td>
      </tr>`;
    modalCache[doc.id] = x; // cache para abrir rápido
  });
}

function slugImagem(nome){
  // remove acentos, troca espaços por _, minúsculas
  return nome
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .toLowerCase()
    .replace(/[^\w\s-]/g,"")
    .trim()
    .replace(/\s+/g,"_") + ".jpg";
}

async function abrirModal(id){
  // se não estiver no cache por algum motivo, busca no Firestore
  let x = modalCache[id];
  if(!x){
    const doc = await db.collection("treinos_extras").doc(id).get();
    x = doc.exists ? doc.data() : null;
  }
  if(!x){ alert("Registro não encontrado."); return; }

  let conteudo = `<h2 class="text-xl font-bold text-blue-600 mb-2">${x.nome_atleta||"-"}</h2>
                  <p class="text-sm text-gray-600 mb-3">${x.data||"-"}</p>`;
  (x.treino_gerado||[]).forEach(gr=>{
    conteudo += `<h3 class="font-semibold mt-3 mb-2 text-blue-600">${gr.categoria}</h3>`;
    (gr.exercicios||[]).forEach(e=>{
      const img = IMG_BASE + slugImagem(e.nome);
      conteudo += `<div class="mb-3">
        <img src="${img}" alt="${e.nome}" class="w-full rounded mb-1" onerror="this.style.display='none'">
        <p class="font-semibold">${e.nome}</p>
        <p class="text-sm text-gray-600">${e.series} — ${e.freq}</p>
      </div>`;
    });
  });
  conteudo += `<button class="btn w-full mt-3" onclick="fecharModal()">Fechar</button>`;

  const modal = document.getElementById("modalDetalhes");
  document.getElementById("modalConteudo").innerHTML = conteudo;
  modal.classList.add("show");  // garante abrir
}
function fecharModal(){
  document.getElementById("modalDetalhes").classList.remove("show");
}
// fecha ao clicar fora
document.getElementById("modalDetalhes").addEventListener("click", (e)=>{
  if(e.target.id==="modalDetalhes") fecharModal();
});

async function excluirTreino(id){
  if(!confirm("Excluir este treino?")) return;
  await db.collection("treinos_extras").doc(id).delete();
  await carregarHistorico();
}
</script>
</body>
</html>
